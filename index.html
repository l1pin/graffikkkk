<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Analytics - TikTok Ads</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8fafc;
      color: #334155;
      min-height: 100vh;
      display: flex;
    }
    
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #1e293b;
      padding: 24px 0;
      box-shadow: 4px 0 12px rgba(0,0,0,0.15);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }
    
    .logo {
      padding: 0 24px 32px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 24px;
    }
    
    .logo h1 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo i {
      font-size: 28px;
    }
    
    .nav-menu {
      padding: 0 16px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .nav-item:hover,
    .nav-item.active {
      background: rgba(255,255,255,0.2);
      color: white;
      transform: translateX(4px);
    }
    
    .nav-item i {
      width: 20px;
      margin-right: 12px;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 24px 32px;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      background: white;
      border-radius: 12px;
      padding: 24px 32px;
      margin-bottom: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .header-subtitle {
      color: #64748b;
      font-size: 16px;
      margin-bottom: 24px;
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 20px;
      align-items: end;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .input-label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    
    .input-field {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #1e293b;
      box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
    }
    
    .period-inputs {
      display: flex;
      gap: 16px;
    }
    
    .btn-primary {
      background: #1e293b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.3);
      height: fit-content;
    }
    
    .btn-primary:hover {
      background: #334155;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 41, 59, 0.4);
    }
    
    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #1e293b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #64748b;
      font-size: 16px;
      font-weight: 500;
    }
    
    /* Error */
    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 20px 24px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 4px solid #dc2626;
      display: none;
      font-weight: 500;
      white-space: pre-line;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
    }
    
    .error-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .error-content {
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* Results */
    .results {
      display: none;
    }
    
    /* Status Banner */
    .status-banner {
      background: #1e293b;
      color: white;
      padding: 20px 32px;
      margin-bottom: 32px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(30, 41, 59, 0.3);
      display: none;
    }
    
    .status-banner.show {
      display: block;
    }
    
    .status-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .status-main {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .status-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .status-info h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
      font-weight: 700;
    }
    
    .status-info p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }
    
    .article-name {
      font-size: 20px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 8px;
    }
    
    /* Metrics */
    .metrics-section {
      margin-bottom: 32px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .section-title i {
      color: #475569;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .metrics-grid.single-row {
      grid-template-columns: repeat(6, 1fr);
    }
    
    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .metric-card.tooltip-container {
      position: relative;
    }
    
    .metric-card.tooltip-container::before {
      content: "ℹ️";
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 16px;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }
    
    .metric-card.tooltip-container:hover::before {
      opacity: 1;
    }
    
    .metric-card.tooltip-container:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.15);
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .metric-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-icon {
      width: 40px;
      height: 40px;
      background: #f1f5f9;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      font-size: 18px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .metric-subtitle {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 500;
    }

    .metric-additional {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #e2e8f0;
    }

    /* Efficiency Zones Styling */
    .efficiency-zones {
      min-height: 240px;
    }
    
    .current-zone-display {
      margin-top: 8px;
      text-align: center;
    }
    
    .zone-percentage {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 20px;
      border: 2px solid;
      margin-bottom: 12px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .zones-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .zone-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      border-left: 3px solid;
      text-align: center;
    }
    
    .zone-red {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: #ef4444;
      color: #dc2626;
    }
    
    .zone-pink {
      background: rgba(236, 72, 153, 0.1);
      border-left-color: #ec4899;
      color: #be185d;
    }
    
    .zone-gold {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: #f59e0b;
      color: #d97706;
    }
    
    .zone-green {
      background: rgba(34, 197, 94, 0.1);
      border-left-color: #22c55e;
      color: #16a34a;
    }
    
    .zone-label {
      font-size: 11px;
      opacity: 0.8;
    }
    
    .zone-value {
      font-weight: 700;
      font-size: 13px;
    }
    
    /* Chart Section */
    .chart-section {
      background: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .chart-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chart-container {
      height: 500px;
      position: relative;
    }
    
    /* Table Section */
    .table-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
    }
    
    .data-table th {
      background: #f8fafc;
      color: #374151;
      font-weight: 600;
      padding: 16px 12px;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    .data-table th:first-child {
      position: sticky;
      left: 0;
      z-index: 11;
      background: #f8fafc;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      min-width: 220px;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
      max-width: 200px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    /* Специальные стили для ячеек с URL */
    .data-table td.url-cell {
      max-width: 400px;
      white-space: normal;
      line-height: 1.4;
      word-break: break-all;
    }
    
    .data-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 9;
      background: inherit;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      min-width: 220px;
    }
    
    .data-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .data-table tbody tr:hover {
      background: #f8fafc;
    }
    
    .data-table .metric-row {
      font-weight: 600;
      color: #374151;
      background: #fafafa !important;
    }
    
    /* Стили для кликабельных ссылок */
    .clickable-url {
      color: #1a73e8;
      text-decoration: underline;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: inline-block;
      margin: 1px 0;
      background: rgba(26, 115, 232, 0.05);
      font-size: 12px;
      word-break: break-all;
      line-height: 1.3;
    }
    
    .clickable-url:hover {
      background: rgba(26, 115, 232, 0.1);
      color: #1557b0;
    }
    
    /* Rating Colors */
    .rating-A { 
      background: #dcfce7 !important; 
      color: #166534 !important;
      font-weight: 600;
    }
    .rating-B { 
      background: #fef3c7 !important; 
      color: #a16207 !important;
      font-weight: 600;
    }
    .rating-C { 
      background: #fed7aa !important; 
      color: #c2410c !important;
      font-weight: 600;
    }
    .rating-D { 
      background: #fecaca !important; 
      color: #dc2626 !important;
      font-weight: 600;
    }
    
    /* BUYER HIERARCHY STYLES */
    .buyer-group-main-section {
      margin-bottom: 48px;
    }
    
    .buyer-group-main-title {
      font-size: 32px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(135deg, #059669, #0891b2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .buyer-group-main-subtitle {
      color: #64748b;
      font-size: 18px;
      margin-bottom: 32px;
      font-weight: 500;
    }
    
    /* Buyer Header - Enhanced */
    .buyer-header-enhanced {
      background: linear-gradient(135deg, #059669 0%, #0891b2 50%, #0284c7 100%);
      color: white;
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 8px 32px rgba(5, 150, 105, 0.3);
      cursor: pointer;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }
    
    .buyer-header-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }
    
    .buyer-header-enhanced:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 48px rgba(5, 150, 105, 0.4);
    }
    
    .buyer-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 24px;
    }
    
    .buyer-main-info h2 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .buyer-main-info p {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
    }
    
    .buyer-toggle-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .buyer-stats-preview {
      background: rgba(255, 255, 255, 0.15);
      padding: 12px 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      font-size: 14px;
      font-weight: 600;
    }
    
    .buyer-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 12px;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .buyer-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .buyer-toggle-btn.collapsed {
      transform: rotate(0deg);
    }
    
    .buyer-toggle-btn.collapsed:hover {
      transform: scale(1.1);
    }
    
    /* Buyer Content Area */
    .buyer-content-area {
      background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 20px;
      padding: 0;
      margin-bottom: 48px;
      overflow: hidden;
      transition: all 0.5s ease;
      max-height: 10000px;
      opacity: 1;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .buyer-content-area.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
      padding: 0;
    }
    
    /* Buyer Metrics Section */
    .buyer-metrics-section {
      padding: 32px;
      border-bottom: 2px solid rgba(5, 150, 105, 0.1);
    }
    
    .buyer-metrics-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .buyer-metrics-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }
    
    /* Buyer Chart Section */
    .buyer-chart-section {
      padding: 32px;
      border-bottom: 2px solid rgba(5, 150, 105, 0.1);
    }
    
    .buyer-chart-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .buyer-chart-container {
      height: 400px;
      position: relative;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    /* TikTok Details Section - NEW */
    .buyer-tiktok-details-section {
      padding: 32px;
      border-bottom: 2px solid rgba(5, 150, 105, 0.1);
    }
    
    .buyer-tiktok-details-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .tiktok-details-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .tiktok-detail-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #f1f5f9;
      transition: all 0.3s ease;
    }
    
    .tiktok-detail-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    .tiktok-detail-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .tiktok-detail-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #059669, #0891b2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }
    
    .tiktok-detail-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tiktok-detail-value {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
      word-break: break-word;
    }
    
    .tiktok-detail-subtitle {
      font-size: 11px;
      color: #94a3b8;
      font-weight: 500;
    }
    
    /* Groups Section within Buyer */
    .buyer-groups-section {
      padding: 32px;
    }
    
    .buyer-groups-title {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Individual Group within Buyer */
    .nested-group-enhanced {
      background: white;
      border-radius: 16px;
      margin-bottom: 24px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      border: 1px solid rgba(5, 150, 105, 0.1);
      transition: all 0.3s ease;
    }
    
    .nested-group-enhanced:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    
    .nested-group-header-enhanced {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      padding: 24px 32px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .nested-group-header-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(5,150,105,0.1) 0%, transparent 50%, rgba(5,150,105,0.05) 100%);
      pointer-events: none;
    }
    
    .nested-group-header-enhanced:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
    }
    
    .nested-group-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 24px;
    }
    
    .nested-group-main-info h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nested-group-main-info p {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }
    
    .nested-group-content-enhanced {
      transition: all 0.4s ease;
      max-height: 5000px;
      opacity: 1;
    }
    
    .nested-group-content-enhanced.collapsed {
      max-height: 0;
      opacity: 0;
    }
    
    .nested-group-metrics {
      padding: 24px 32px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .nested-group-metrics-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nested-group-metrics-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
    }
    
    .nested-group-chart {
      padding: 24px 32px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .nested-group-chart-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nested-group-chart-container {
      height: 350px;
      position: relative;
      background: #fafafa;
      border-radius: 8px;
      padding: 16px;
    }
    
    /* TikTok Details for Groups - NEW */
    .nested-group-tiktok-details {
      padding: 24px 32px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .nested-group-tiktok-details-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nested-group-tiktok-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    
    .nested-group-table {
      padding: 24px 32px;
    }
    
    .nested-group-table-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Enhanced Metric Cards */
    .metric-card-enhanced {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #f1f5f9;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .metric-card-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, #059669, #0891b2);
    }
    
    .metric-card-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    .metric-card-enhanced .metric-header {
      margin-bottom: 12px;
    }
    
    .metric-card-enhanced .metric-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-card-enhanced .metric-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #059669, #0891b2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }
    
    .metric-card-enhanced .metric-value {
      font-size: 24px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 6px;
    }
    
    .metric-card-enhanced .metric-subtitle {
      font-size: 11px;
      color: #94a3b8;
      font-weight: 500;
    }
    
    /* Стили для всплывающих подсказок (Tooltips) */
    .tooltip-container {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    
    .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.95);
      color: white;
      padding: 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      line-height: 1.4;
      white-space: nowrap;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-line;
    }
    
    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -8px;
      border-width: 8px;
      border-style: solid;
      border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
    }
    
    .tooltip-container:hover .tooltip {
      visibility: visible;
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }
    
    .tooltip-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 8px;
      color: #60a5fa;
      border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      padding-bottom: 4px;
    }
    
    .tooltip-item {
      display: block;
      padding: 2px 0;
      color: #e2e8f0;
    }
    
    .tooltip-item:hover {
      color: #60a5fa;
    }
    
    /* Скролл для длинных списков */
    .tooltip::-webkit-scrollbar {
      width: 6px;
    }
    
    .tooltip::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    .tooltip::-webkit-scrollbar-thumb {
      background: rgba(96, 165, 250, 0.5);
      border-radius: 3px;
    }
    
    .tooltip::-webkit-scrollbar-thumb:hover {
      background: rgba(96, 165, 250, 0.7);
    }
    
    /* Адаптивное позиционирование tooltip для правого края */
    .tooltip-container:last-child .tooltip,
    .tooltip-container:nth-last-child(2) .tooltip {
      left: auto;
      right: 0;
      transform: translateX(0);
    }
    
    .tooltip-container:last-child:hover .tooltip,
    .tooltip-container:nth-last-child(2):hover .tooltip {
      transform: translateX(0) translateY(-8px);
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
      
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .metrics-grid.single-row {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .buyer-metrics-grid, .nested-group-metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .tiktok-details-grid, .nested-group-tiktok-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 20px;
      }
      
      .metric-card {
        padding: 20px;
      }
      
      .chart-section,
      .table-section {
        padding: 20px;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .metrics-grid.single-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .buyer-metrics-grid, .nested-group-metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .tiktok-details-grid, .nested-group-tiktok-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .metrics-grid.single-row {
        grid-template-columns: 1fr;
      }
      
      .buyer-metrics-grid, .nested-group-metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <h1><i class="fas fa-chart-line"></i> TikTok Ads</h1>
    </div>
    <nav class="nav-menu">
      <a href="#" class="nav-item active">
        <i class="fas fa-chart-bar"></i>
        Аналитика
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <h1>Аналитика по артикулам</h1>
      <div class="header-subtitle">Детальный анализ показателей эффективности рекламных кампаний TikTok Ads из базы данных</div>
      
      <div class="controls-grid">
        <div class="input-group">
          <label class="input-label">Артикул для анализа</label>
          <input type="text" id="articleInput" class="input-field" placeholder="Введите артикул..." />
        </div>
        
        <div class="period-inputs">
          <div class="input-group">
            <label class="input-label">Период с</label>
            <input type="date" id="periodStart" class="input-field">
          </div>
          <div class="input-group">
            <label class="input-label">по</label>
            <input type="date" id="periodEnd" class="input-field">
          </div>
        </div>
        
        <button id="buildChart" class="btn-primary" onclick="buildChart()">
          <i class="fas fa-chart-line"></i> Построить анализ
        </button>
      </div>
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">Обработка данных из базы данных...</div>
    </div>
    
    <!-- Error -->
    <div class="error" id="error">
      <div class="error-title">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Произошла ошибка</span>
      </div>
      <div class="error-content" id="errorContent"></div>
    </div>
    
    <!-- Results -->
    <div class="results" id="results">
      <!-- Status Banner -->
      <div class="status-banner" id="statusBanner"></div>
      
      <!-- General Metrics -->
      <div class="metrics-section">
        <h2 class="section-title">
          <i class="fas fa-chart-pie"></i>
          Ключевые показатели
        </h2>
        <div class="metrics-grid" id="generalMetrics"></div>
      </div>
      
      <!-- General Chart -->
      <div class="chart-section">
        <div class="chart-header">
          <div class="chart-title">📊 Динамика показателей</div>
          <div style="color: #64748b; font-size: 14px;">
            <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-right: 8px;"></span>
            Данные из базы данных
          </div>
        </div>
        <div class="chart-container">
          <canvas id="generalChart"></canvas>
        </div>
      </div>
      
      <!-- General Table -->
      <div class="table-section">
        <div class="chart-header">
          <div class="chart-title">Детальные данные</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="generalTable"></table>
        </div>
      </div>
      
      <!-- Buyer-Group Hierarchy -->
      <div id="buyerGroupsContainer"></div>
    </div>
  </div>

  <script>
    let currentCharts = [];
    
    // Функция для форматирования содержимого подсказок
    function formatTooltipContent(content, isUrls = false) {
      if (!content || content === 'Нет данных' || content.trim() === '') {
        return '<span class="tooltip-item" style="color: #94a3b8; font-style: italic;">Нет данных</span>';
      }
      
      // Разделяем по переносам строк и убираем пустые элементы
      const items = content.split('\n').filter(item => item.trim() !== '');
      
      if (items.length === 0) {
        return '<span class="tooltip-item" style="color: #94a3b8; font-style: italic;">Нет данных</span>';
      }
      
      // Убираем дубликаты и сортируем
      const uniqueItems = [...new Set(items)].sort();
      
      return uniqueItems.map((item, index) => {
        const trimmedItem = item.trim();
        
        if (isUrls && (trimmedItem.startsWith('http://') || trimmedItem.startsWith('https://'))) {
          // Для URL делаем кликабельными
          return `<a href="${trimmedItem}" target="_blank" class="tooltip-item" style="color: #60a5fa; text-decoration: underline;">${trimmedItem}</a>`;
        }
        
        return `<span class="tooltip-item">${escapeHtml(trimmedItem)}</span>`;
      }).join('\n');
    }
    
    // Функция для создания кликабельных ссылок
    function makeUrlsClickable(text) {
      if (!text || text.trim() === '') return '';
      
      const urls = text.split('\n').filter(url => url.trim() !== '');
      return urls.map(url => {
        const cleanUrl = url.trim();
        if (cleanUrl.startsWith('http://') || cleanUrl.startsWith('https://')) {
          return `<a href="${cleanUrl}" target="_blank" class="clickable-url" title="${cleanUrl}">${cleanUrl}</a>`;
        }
        return cleanUrl;
      }).join('<br>');
    }
    
    // Функция для получения среднего значения массива строк
    function getAverageFromStringArray(strArray) {
      if (!Array.isArray(strArray) || strArray.length === 0) return 'Нет данных';
      
      const numbers = strArray
        .filter(item => item && item.trim() !== '')
        .map(item => {
          const num = parseFloat(String(item).replace(',', '.'));
          return isNaN(num) ? null : num;
        })
        .filter(num => num !== null);
      
      if (numbers.length === 0) return 'Нет данных';
      
      const average = numbers.reduce((sum, num) => sum + num, 0) / numbers.length;
      return average.toFixed(2).replace('.', ',');
    }
    
    // Функция для получения общего количества из массива строк
    function getTotalFromStringArray(strArray) {
      if (!Array.isArray(strArray) || strArray.length === 0) return 'Нет данных';
      
      const numbers = strArray
        .filter(item => item && item.trim() !== '')
        .map(item => {
          const num = parseInt(String(item).replace(',', '.'));
          return isNaN(num) ? null : num;
        })
        .filter(num => num !== null);
      
      if (numbers.length === 0) return 'Нет данных';
      
      const total = numbers.reduce((sum, num) => sum + num, 0);
      return total.toString();
    }
    
    // Функция для получения уникальных значений из массива строк
    function getUniqueFromStringArray(strArray) {
      if (!Array.isArray(strArray) || strArray.length === 0) return 'Нет данных';
      
      const allItems = [];
      strArray.forEach(item => {
        if (item && item.trim() !== '') {
          const subItems = String(item).split('\n').filter(subItem => subItem.trim() !== '');
          allItems.push(...subItems);
        }
      });
      
      const uniqueItems = [...new Set(allItems.map(item => item.trim()))];
      return uniqueItems.length > 0 ? uniqueItems.length.toString() : 'Нет данных';
    }
    
    // Функция для сворачивания/разворачивания байеров в иерархии
    function toggleBuyerGroup(buyerId) {
      const content = document.getElementById(buyerId + '_content');
      const toggle = event.currentTarget.querySelector('.buyer-toggle-btn i');
      
      if (content.classList.contains('collapsed')) {
        // Разворачиваем
        content.classList.remove('collapsed');
        toggle.classList.remove('fa-chevron-right');
        toggle.classList.add('fa-chevron-down');
        toggle.parentElement.classList.remove('collapsed');
      } else {
        // Сворачиваем
        content.classList.add('collapsed');
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-right');
        toggle.parentElement.classList.add('collapsed');
      }
    }
    
    // Функция для сворачивания/разворачивания вложенных групп
    function toggleNestedGroup(groupId) {
      const content = document.getElementById(groupId + '_content');
      const toggle = event.currentTarget.querySelector('.buyer-toggle-btn i');
      
      if (content.classList.contains('collapsed')) {
        // Разворачиваем
        content.classList.remove('collapsed');
        toggle.classList.remove('fa-chevron-right');
        toggle.classList.add('fa-chevron-down');
        toggle.parentElement.classList.remove('collapsed');
      } else {
        // Сворачиваем
        content.classList.add('collapsed');
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-right');
        toggle.parentElement.classList.add('collapsed');
      }
    }
    
    // Делаем функции глобально доступными
    window.toggleBuyerGroup = toggleBuyerGroup;
    window.toggleNestedGroup = toggleNestedGroup;
    
    function buildChart() {
      const article = document.getElementById('articleInput').value.trim();
      const periodStart = document.getElementById('periodStart').value;
      const periodEnd = document.getElementById('periodEnd').value;
      
      if (!article) {
        showError('📝 Введите артикул\n\nПожалуйста, укажите артикул для анализа в поле ввода.');
        return;
      }
      
      showLoading(true);
      hideError();
      hideResults();
      
      // Уничтожаем существующие графики
      currentCharts.forEach(chart => {
        try {
          chart.destroy();
        } catch(e) {
          console.log('Ошибка при уничтожении графика:', e);
        }
      });
      currentCharts = [];
      
      // Вызываем Google Apps Script функцию
      try {
        console.log('🚀 Запуск анализа для артикула:', article);
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .buildChartForArticle(article, periodStart, periodEnd);
      } catch (e) {
        console.error('❌ Ошибка при вызове Google Apps Script:', e);
        handleError('🔌 Google Apps Script недоступен!\n\nПроверьте подключение к интернету и обновите страницу.');
      }
    }
    
    function handleSuccess(data) {
      console.log('✅ Получены данные от Google Apps Script:', data);
      showLoading(false);
      displayResults(data);
    }
    
    function handleError(error) {
      console.error('❌ Ошибка Google Apps Script:', error);
      showLoading(false);
      showError(error.toString());
    }
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('buildChart').disabled = show;
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('error');
      const errorContent = document.getElementById('errorContent');
      errorContent.textContent = message;
      errorDiv.style.display = 'block';
    }
    
    function hideError() {
      document.getElementById('error').style.display = 'none';
    }
    
    function hideResults() {
      document.getElementById('results').style.display = 'none';
      document.getElementById('statusBanner').classList.remove('show');
    }
    
    function showResults() {
      document.getElementById('results').style.display = 'block';
    }
    
    function displayResults(data) {
      console.log('📊 Отображаем результаты:', data);
      
      // Статус баннер
      displayStatusBanner(data.article, data.generalMetrics);
      
      // Общие метрики
      displayGeneralMetrics(data.generalMetrics);
      
      // Общий график
      displayGeneralChart(data.article, data.generalData);
      
      // Общая таблица
      displayGeneralTable(data.generalData);
      
      // Деревовидная структура Байер → Группа
      displayBuyerGroups(data.article, data.buyerGroupsData || {});
      
      showResults();
    }
    
    function displayStatusBanner(article, metrics) {
      const container = document.getElementById('statusBanner');
      container.innerHTML = `
        <div class="status-content">
          <div class="status-main">
            <div class="status-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="status-info">
              <h3>Статус артикула</h3>
              <p>${escapeHtml(metrics.status || 'Активный')}</p>
            </div>
          </div>
          <div class="article-name">${escapeHtml(article)}</div>
        </div>
      `;
      container.classList.add('show');
    }
    
    function displayGeneralMetrics(metrics) {
      const container = document.getElementById('generalMetrics');
      
      // Получаем динамические цвета из Google Sheets или дефолтные
      let zoneValue, zoneBackground, zoneFontColor;
      
      if (typeof metrics.efficiencyZone === 'object' && metrics.efficiencyZone !== null) {
        zoneValue = metrics.efficiencyZone.value || '--,--%';
        zoneBackground = metrics.efficiencyZone.backgroundColor || '#f3f3f3';
        zoneFontColor = metrics.efficiencyZone.fontColor || '#666666';
      } else {
        zoneValue = metrics.efficiencyZone || '--,--%';
        zoneBackground = '#f3f3f3';
        zoneFontColor = '#666666';
      }
      
      console.log('Zone styling - Value:', zoneValue, 'Background:', zoneBackground, 'Font:', zoneFontColor);
      
      container.innerHTML = `
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Активных дней</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">дней с активностью</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Дней в норме</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">≤ ${metrics.displayMaxCPL} CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Дней ниже допустимой</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">≤ ${metrics.displayCPL_ROI_minus5} CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Конверсия</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">средний CR</div>
        </div>

        <div class="metric-card efficiency-zones">
          <div class="metric-header">
            <div class="metric-label">Зоны эффективности</div>
            <div class="metric-icon"><i class="fas fa-bullseye"></i></div>
          </div>
          <div class="current-zone-display">
            <div class="zone-percentage" style="background-color: ${zoneBackground} !important; color: ${zoneFontColor} !important; border-color: ${zoneFontColor};">${zoneValue}</div>
            <div class="metric-subtitle">текущая зона</div>
          </div>
          <div class="zones-grid">
            <div class="zone-item zone-red">
              <span class="zone-label">Красная:</span>
              <span class="zone-value">${metrics.zoneAB || '-'}</span>
            </div>
            <div class="zone-item zone-pink">
              <span class="zone-label">Розовая:</span>
              <span class="zone-value">${metrics.zoneAC || '-'}</span>
            </div>
            <div class="zone-item zone-gold">
              <span class="zone-label">Золотая:</span>
              <span class="zone-value">${metrics.zoneAD || '-'}</span>
            </div>
            <div class="zone-item zone-green">
              <span class="zone-label">Зеленая:</span>
              <span class="zone-value">${metrics.zoneAE || '-'}</span>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Остаток</div>
            <div class="metric-icon"><i class="fas fa-boxes"></i></div>
          </div>
          <div class="metric-value">${escapeHtml(metrics.stock || 'Не указано')}</div>
          <div class="metric-subtitle">на складе</div>
          <div class="metric-additional">На сколько дней: ${escapeHtml(metrics.stockDays || 'Не указано')}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Сезонность</div>
            <div class="metric-icon"><i class="fas fa-calendar-alt"></i></div>
          </div>
          <div class="metric-value" style="font-size: 18px;">${escapeHtml(metrics.season || 'Неизвестно')}</div>
          <div class="metric-subtitle">периоды активности</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Категория</div>
            <div class="metric-icon"><i class="fas fa-tags"></i></div>
          </div>
          <div class="metric-value" style="font-size: 18px;">${escapeHtml(metrics.category || 'Не указана')}</div>
          <div class="metric-subtitle">товарная группа</div>
        </div>
        
        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Всего групп</div>
            <div class="metric-icon"><i class="fas fa-layer-group"></i></div>
          </div>
          <div class="metric-value">${metrics.totalGroups}</div>
          <div class="metric-subtitle">активных групп</div>
          <div class="tooltip">
            <div class="tooltip-title">📁 Группы объявлений:</div>
            ${formatTooltipContent(metrics.groupNames || 'Нет данных')}
          </div>
        </div>

        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Байеров</div>
            <div class="metric-icon"><i class="fas fa-user-tie"></i></div>
          </div>
          <div class="metric-value">${metrics.totalBuyers}</div>
          <div class="metric-subtitle">медиабайеров</div>
          <div class="tooltip">
            <div class="tooltip-title">👤 Медиабайеры:</div>
            ${formatTooltipContent(metrics.buyerNames || 'Нет данных')}
          </div>
        </div>

        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Аккаунтов</div>
            <div class="metric-icon"><i class="fas fa-users"></i></div>
          </div>
          <div class="metric-value">${metrics.totalAccounts}</div>
          <div class="metric-subtitle">рекламных аккаунтов</div>
          <div class="tooltip">
            <div class="tooltip-title">🔑 Рекламные аккаунты:</div>
            ${formatTooltipContent(metrics.accountNames || 'Нет данных')}
          </div>
        </div>
        
        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Уникальных видео</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">креативов</div>
          <div class="tooltip">
            <div class="tooltip-title">🎬 Видео креативы:</div>
            ${formatTooltipContent(metrics.videoNames || 'Нет данных')}
          </div>
        </div>
        
        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Лендингов</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">посадочных страниц</div>
          <div class="tooltip">
            <div class="tooltip-title">🌐 Посадочные страницы:</div>
            ${formatTooltipContent(metrics.siteUrls || 'Нет данных', true)}
          </div>
        </div>
      `;
    }
    
    function displayGeneralChart(article, data) {
      const ctx = document.getElementById('generalChart').getContext('2d');
      
      // Создаем градиенты
      const gradientCPL = ctx.createLinearGradient(0, 0, 0, 400);
      gradientCPL.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
      gradientCPL.addColorStop(0.5, 'rgba(99, 102, 241, 0.15)');
      gradientCPL.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
      
      const gradientLeads = ctx.createLinearGradient(0, 0, 0, 400);
      gradientLeads.addColorStop(0, 'rgba(34, 197, 94, 0.25)');
      gradientLeads.addColorStop(1, 'rgba(34, 197, 94, 0.05)');
      
      const gradientSpend = ctx.createLinearGradient(0, 0, 0, 400);
      gradientSpend.addColorStop(0, 'rgba(251, 146, 60, 0.25)');
      gradientSpend.addColorStop(1, 'rgba(251, 146, 60, 0.05)');
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [
            {
              label: 'CPL за день',
              data: data.cplDay,
              borderColor: '#6366f1',
              backgroundColor: gradientCPL,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 8,
              pointBackgroundColor: '#6366f1',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              tension: 0,
              fill: true,
              order: 1
            },
            {
              label: 'Лиды за день',
              data: data.leadsDay,
              borderColor: '#22c55e',
              backgroundColor: gradientLeads,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#22c55e',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 2
            },
            {
              label: 'Расход за день',
              data: data.spendDay,
              borderColor: '#fb923c',
              backgroundColor: gradientSpend,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#fb923c',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 3
            },
            {
              label: 'Max CPL (норма)',
              data: data.maxCPL,
              borderColor: '#ef4444',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderDash: [10, 5],
              tension: 0,
              order: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            title: {
              display: true,
              text: `📊 Динамика показателей - ${article}`,
              font: {
                size: 22,
                weight: 'bold'
              },
              color: '#1e293b'
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.95)',
              titleColor: '#ffffff',
              bodyColor: '#e2e8f0',
              borderColor: '#475569',
              borderWidth: 1,
              cornerRadius: 12
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(148, 163, 184, 0.15)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: '💰 CPL ($)',
                color: '#374151'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return '$' + value.toFixed(1);
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: '📈 Лиды / Расход',
                color: '#374151'
              },
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          }
        }
      });
      
      currentCharts.push(chart);
    }
    
    function displayGeneralTable(data) {
      console.log('📋 Отображаем общую таблицу с данными:', data);
      
      const table = document.getElementById('generalTable');
      const rows = [
        'Дата',
        'Рейтинг',
        'CPL (день)',
        'Лиды (день)',
        'Расход (день)',
        'Конверт в день',
        'Max CPL (ROI +20%)',
        'CPL с учётом сбросов',
        'Группы',
        'Байеры',
        'Аккаунты',
        'Частота (Frequency)',
        'CTR (целевая страница)',
        'CPM',
        'Клики (переход)',
        'CPC (целевая страница)',
        'Среднее время воспроизведения видео',
        'Название рекламы',
        'URL-адрес веб-сайта',
        'Бюджет группы объявлений'
      ];
      
      let html = '<thead><tr><th style="min-width: 220px;">Показатель</th>';
      data.dates.forEach(date => {
        html += `<th style="min-width: 140px;">${date}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      rows.forEach((rowName, index) => {
        html += `<tr><td class="metric-row">${rowName}</td>`;
        for (let i = 0; i < data.dates.length; i++) {
          let value = '';
          let className = '';
          let cellStyle = '';
          
          switch(index) {
            case 0: value = data.dates[i]; break;
            case 1: 
              value = data.ratings[i]; 
              className = value ? `rating-${value}` : '';
              break;
            case 2: value = formatNumberWithZero(data.cplDay[i]); break;
            case 3: value = data.leadsDay[i]; break;
            case 4: value = formatNumberWithZero(data.spendDay[i]); break;
            case 5: value = data.conversionDay ? data.conversionDay[i] : ''; break;
            case 6: value = formatNumber(data.maxCPL[i]); break;
            case 7:
              value = formatNumberWithZero(data.cplCumulative[i]);
              if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                value += ' ' + data.cplCumulativeArrows[i];
              }
              if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                const color = data.cplCumulativeColors[i];
                if (color === 'green') {
                  cellStyle = 'background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;';
                } else if (color === 'red') {
                  cellStyle = 'background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;';
                } else if (color === 'gray') {
                  cellStyle = 'background-color: #f3f4f6 !important; color: #6b7280 !important;';
                }
              }
              break;
            case 8: value = data.groups ? data.groups[i] : ''; break;
            case 9: value = data.buyers ? data.buyers[i] : ''; break;
            case 10: value = data.accounts ? data.accounts[i] : ''; break;
            case 11: value = data.freq ? data.freq[i] : ''; break;
            case 12: value = data.ctr ? data.ctr[i] : ''; break;
            case 13: value = data.cpm ? data.cpm[i] : ''; break;
            case 14: value = data.linkClicks ? data.linkClicks[i] : ''; break;
            case 15: value = data.cpc ? data.cpc[i] : ''; break;
            case 16: value = data.avgWatchTime ? data.avgWatchTime[i] : ''; break;
            case 17: value = data.videoName ? data.videoName[i] : ''; break;
            case 18: 
              // Обрабатываем URL-адреса - делаем их кликабельными
              const urlValue = data.siteUrl ? data.siteUrl[i] : '';
              value = makeUrlsClickable(urlValue);
              break;
            case 19: value = data.budget ? data.budget[i] : ''; break;
          }
          
          if (index === 18) {
            // Для URL-адресов вставляем HTML напрямую и добавляем класс url-cell
            html += `<td class="${className} url-cell" style="${cellStyle}">${value}</td>`;
          } else {
            html += `<td class="${className}" style="${cellStyle}">${escapeHtml(value)}</td>`;
          }
        }
        html += '</tr>';
      });
      
      html += '</tbody>';
      table.innerHTML = html;
    }
    
    function displayBuyerGroups(article, buyerGroupsData) {
      console.log('🌲 Отображаем деревовидную структуру с TikTok данными:', buyerGroupsData);
      
      const container = document.getElementById('buyerGroupsContainer');
      let html = '';
      
      if (Object.keys(buyerGroupsData).length > 0) {
        html += `
          <div class="buyer-group-main-section">
            <h2 class="buyer-group-main-title">
              <i class="fas fa-sitemap"></i>
              Детальная аналитика по медиабайерам
            </h2>
            <div class="buyer-group-main-subtitle">
              Полная иерархическая структура: Байер → Группы объявлений с детальными метриками TikTok, графиками и таблицами
            </div>
          </div>
        `;
        
        Object.keys(buyerGroupsData).forEach(buyerName => {
          const buyerData = buyerGroupsData[buyerName];
          const buyerId = `enhanced_buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const groupsCount = Object.keys(buyerData.groups || {}).length;
          const buyerChartId = `buyer_chart_${buyerId}`;
          
          html += `
            <div class="buyer-group-section">
              <!-- BUYER HEADER -->
              <div class="buyer-header-enhanced" onclick="toggleBuyerGroup('${buyerId}')">
                <div class="buyer-info-grid">
                  <div class="buyer-main-info">
                    <h2>
                      <i class="fas fa-user-tie"></i>
                      ${escapeHtml(buyerName)}
                    </h2>
                    <p>Медиабайер • ${groupsCount} ${groupsCount === 1 ? 'группа' : groupsCount < 5 ? 'группы' : 'групп'} объявлений</p>
                  </div>
                  <div class="buyer-toggle-section">
                    ${buyerData.buyerData ? `
                      <div class="buyer-stats-preview">
                        ${buyerData.buyerData.metrics.activeDays} дней • CR ${buyerData.buyerData.metrics.cr}
                      </div>
                    ` : ''}
                    <button class="buyer-toggle-btn collapsed" type="button">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- BUYER CONTENT AREA - СВЕРНУТО ПО УМОЛЧАНИЮ -->
              <div class="buyer-content-area collapsed" id="${buyerId}_content">
                
                <!-- BUYER METRICS SECTION -->
                ${buyerData.buyerData ? `
                  <div class="buyer-metrics-section">
                    <h3 class="buyer-metrics-title">
                      <i class="fas fa-chart-pie"></i>
                      Ключевые показатели байера
                    </h3>
                    <div class="buyer-metrics-grid">
                      ${generateEnhancedBuyerMetrics(buyerData.buyerData.metrics)}
                    </div>
                  </div>
                  
                  <!-- BUYER TIKTOK DETAILS SECTION - NEW -->
                  <div class="buyer-tiktok-details-section">
                    <h3 class="buyer-tiktok-details-title">
                      <i class="fab fa-tiktok"></i>
                      Детали TikTok рекламы
                    </h3>
                    <div class="tiktok-details-grid">
                      ${generateTikTokDetails(buyerData.buyerData.data)}
                    </div>
                  </div>
                  
                  <!-- BUYER CHART SECTION -->
                  <div class="buyer-chart-section">
                    <h3 class="buyer-chart-title">
                      <i class="fas fa-chart-line"></i>
                      График динамики байера
                    </h3>
                    <div class="buyer-chart-container">
                      <canvas id="${buyerChartId}"></canvas>
                    </div>
                  </div>
                  
                  <!-- BUYER TABLE SECTION -->
                  <div class="buyer-chart-section">
                    <h3 class="buyer-chart-title">
                      <i class="fas fa-table"></i>
                      Детальные данные байера
                    </h3>
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
                      <div class="table-container">
                        <table class="data-table" id="buyer_table_${buyerId}"></table>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                <!-- BUYER GROUPS SECTION -->
                <div class="buyer-groups-section">
                  <h3 class="buyer-groups-title">
                    <i class="fas fa-folder-tree"></i>
                    Группы объявлений (${groupsCount})
                  </h3>
                  
                  ${Object.keys(buyerData.groups || {}).map(groupName => {
                    const groupData = buyerData.groups[groupName];
                    const nestedGroupId = `enhanced_group_${buyerId}_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const chartId = `chart_${nestedGroupId}`;
                    const tableId = `table_${nestedGroupId}`;
                    
                    return `
                      <div class="nested-group-enhanced">
                        <!-- GROUP HEADER -->
                        <div class="nested-group-header-enhanced" onclick="toggleNestedGroup('${nestedGroupId}')">
                          <div class="nested-group-info-grid">
                            <div class="nested-group-main-info">
                              <h3>
                                <i class="fas fa-folder"></i>
                                ${escapeHtml(groupName)}
                              </h3>
                              <p>Группа объявлений • ${groupData.metrics.activeDays} активных дней • CR ${groupData.metrics.cr}</p>
                            </div>
                            <div class="buyer-toggle-section">
                              <div class="buyer-stats-preview">
                                ${groupData.metrics.videos} видео • ${groupData.metrics.sites} лендингов
                              </div>
                              <button class="buyer-toggle-btn collapsed" type="button">
                                <i class="fas fa-chevron-right"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                        
                        <!-- GROUP CONTENT - СВЕРНУТО ПО УМОЛЧАНИЮ -->
                        <div class="nested-group-content-enhanced collapsed" id="${nestedGroupId}_content">
                          
                          <!-- GROUP METRICS -->
                          <div class="nested-group-metrics">
                            <h4 class="nested-group-metrics-title">
                              <i class="fas fa-chart-bar"></i>
                              Метрики группы
                            </h4>
                            <div class="nested-group-metrics-grid">
                              ${generateEnhancedGroupMetrics(groupData.metrics)}
                            </div>
                          </div>
                          
                          <!-- GROUP TIKTOK DETAILS - NEW -->
                          <div class="nested-group-tiktok-details">
                            <h4 class="nested-group-tiktok-details-title">
                              <i class="fab fa-tiktok"></i>
                              Детали TikTok рекламы группы
                            </h4>
                            <div class="nested-group-tiktok-grid">
                              ${generateTikTokDetailsGroup(groupData.data)}
                            </div>
                          </div>
                          
                          <!-- GROUP CHART -->
                          <div class="nested-group-chart">
                            <h4 class="nested-group-chart-title">
                              <i class="fas fa-chart-area"></i>
                              График динамики
                            </h4>
                            <div class="nested-group-chart-container">
                              <canvas id="${chartId}"></canvas>
                            </div>
                          </div>
                          
                          <!-- GROUP TABLE -->
                          <div class="nested-group-table">
                            <h4 class="nested-group-table-title">
                              <i class="fas fa-table"></i>
                              Детальные данные
                            </h4>
                            <div class="table-container">
                              <table class="data-table" id="${tableId}"></table>
                            </div>
                          </div>
                          
                        </div>
                      </div>
                    `;
                  }).join('')}
                  
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // Создаем графики и таблицы
        Object.keys(buyerGroupsData).forEach(buyerName => {
          const buyerData = buyerGroupsData[buyerName];
          const buyerId = `enhanced_buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const buyerChartId = `buyer_chart_${buyerId}`;
          const buyerTableId = `buyer_table_${buyerId}`;
          
          // График И ТАБЛИЦА для байера
          if (buyerData.buyerData) {
            displaySegmentChart(buyerChartId, article, buyerName, buyerData.buyerData.data);
            displaySegmentTable(buyerTableId, buyerData.buyerData.data);
          }
          
          // Графики и таблицы для групп
          Object.keys(buyerData.groups || {}).forEach(groupName => {
            const groupData = buyerData.groups[groupName];
            const nestedGroupId = `enhanced_group_${buyerId}_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const chartId = `chart_${nestedGroupId}`;
            const tableId = `table_${nestedGroupId}`;
            
            displaySegmentTable(tableId, groupData.data);
            displaySegmentChart(chartId, article, `${buyerName} → ${groupName}`, groupData.data);
          });
        });
      } else {
        container.innerHTML = `
          <div class="buyer-group-main-section">
            <h2 class="buyer-group-main-title">
              <i class="fas fa-sitemap"></i>
              Детальная аналитика по медиабайерам
            </h2>
            <div class="buyer-group-main-subtitle">
              Данные не найдены для выбранного артикула и периода
            </div>
          </div>
        `;
      }
    }
    
    // Функция для генерации TikTok деталей для байера
    function generateTikTokDetails(data) {
      if (!data) return '';
      
      // Собираем все значения для каждой метрики
      const allFreq = [], allCtr = [], allCpm = [], allLinkClicks = [], allCpc = [], allAvgWatchTime = [];
      const allVideoNames = [], allSiteUrls = [], allBudgets = [];
      
      data.freq?.forEach(item => { if (item) allFreq.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.ctr?.forEach(item => { if (item) allCtr.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.cpm?.forEach(item => { if (item) allCpm.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.linkClicks?.forEach(item => { if (item) allLinkClicks.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.cpc?.forEach(item => { if (item) allCpc.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.avgWatchTime?.forEach(item => { if (item) allAvgWatchTime.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.videoName?.forEach(item => { if (item) allVideoNames.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.siteUrl?.forEach(item => { if (item) allSiteUrls.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.budget?.forEach(item => { if (item) allBudgets.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      
      return `
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-mouse-pointer"></i></div>
            <div class="tiktok-detail-label">Средняя частота</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allFreq)}</div>
          <div class="tiktok-detail-subtitle">показов на пользователя</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-percentage"></i></div>
            <div class="tiktok-detail-label">Средний CTR</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allCtr)}%</div>
          <div class="tiktok-detail-subtitle">клики к показам</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="tiktok-detail-label">Средний CPM</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allCpm)}</div>
          <div class="tiktok-detail-subtitle">за 1000 показов</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-hand-pointer"></i></div>
            <div class="tiktok-detail-label">Всего кликов</div>
          </div>
          <div class="tiktok-detail-value">${getTotalFromStringArray(allLinkClicks)}</div>
          <div class="tiktok-detail-subtitle">переходов на сайт</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-coins"></i></div>
            <div class="tiktok-detail-label">Средний CPC</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allCpc)}</div>
          <div class="tiktok-detail-subtitle">за клик</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-play"></i></div>
            <div class="tiktok-detail-label">Среднее время просмотра</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allAvgWatchTime)}с</div>
          <div class="tiktok-detail-subtitle">просмотра видео</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-video"></i></div>
            <div class="tiktok-detail-label">Уникальных видео</div>
          </div>
          <div class="tiktok-detail-value">${getUniqueFromStringArray(allVideoNames)}</div>
          <div class="tiktok-detail-subtitle">креативов</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-globe"></i></div>
            <div class="tiktok-detail-label">Уникальных лендингов</div>
          </div>
          <div class="tiktok-detail-value">${getUniqueFromStringArray(allSiteUrls)}</div>
          <div class="tiktok-detail-subtitle">посадочных страниц</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-wallet"></i></div>
            <div class="tiktok-detail-label">Общий бюджет</div>
          </div>
          <div class="tiktok-detail-value">${getTotalFromStringArray(allBudgets)}</div>
          <div class="tiktok-detail-subtitle">выделенных средств</div>
        </div>
      `;
    }
    
    // Функция для генерации TikTok деталей для группы
    function generateTikTokDetailsGroup(data) {
      if (!data) return '';
      
      // Собираем все значения для каждой метрики
      const allFreq = [], allCtr = [], allCpm = [], allLinkClicks = [], allCpc = [], allAvgWatchTime = [];
      const allVideoNames = [], allSiteUrls = [], allBudgets = [];
      
      data.freq?.forEach(item => { if (item) allFreq.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.ctr?.forEach(item => { if (item) allCtr.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.cpm?.forEach(item => { if (item) allCpm.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.linkClicks?.forEach(item => { if (item) allLinkClicks.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.cpc?.forEach(item => { if (item) allCpc.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.avgWatchTime?.forEach(item => { if (item) allAvgWatchTime.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.videoName?.forEach(item => { if (item) allVideoNames.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.siteUrl?.forEach(item => { if (item) allSiteUrls.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      data.budget?.forEach(item => { if (item) allBudgets.push(...String(item).split('\n').filter(v => v.trim() !== '')); });
      
      return `
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-mouse-pointer"></i></div>
            <div class="tiktok-detail-label">Средняя частота</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allFreq)}</div>
          <div class="tiktok-detail-subtitle">показов на пользователя</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-percentage"></i></div>
            <div class="tiktok-detail-label">Средний CTR</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allCtr)}%</div>
          <div class="tiktok-detail-subtitle">клики к показам</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="tiktok-detail-label">Средний CPM</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allCpm)}</div>
          <div class="tiktok-detail-subtitle">за 1000 показов</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-hand-pointer"></i></div>
            <div class="tiktok-detail-label">Всего кликов</div>
          </div>
          <div class="tiktok-detail-value">${getTotalFromStringArray(allLinkClicks)}</div>
          <div class="tiktok-detail-subtitle">переходов на сайт</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-coins"></i></div>
            <div class="tiktok-detail-label">Средний CPC</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allCpc)}</div>
          <div class="tiktok-detail-subtitle">за клик</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-play"></i></div>
            <div class="tiktok-detail-label">Среднее время просмотра</div>
          </div>
          <div class="tiktok-detail-value">${getAverageFromStringArray(allAvgWatchTime)}с</div>
          <div class="tiktok-detail-subtitle">просмотра видео</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-video"></i></div>
            <div class="tiktok-detail-label">Уникальных видео</div>
          </div>
          <div class="tiktok-detail-value">${getUniqueFromStringArray(allVideoNames)}</div>
          <div class="tiktok-detail-subtitle">креативов</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-globe"></i></div>
            <div class="tiktok-detail-label">Уникальных лендингов</div>
          </div>
          <div class="tiktok-detail-value">${getUniqueFromStringArray(allSiteUrls)}</div>
          <div class="tiktok-detail-subtitle">посадочных страниц</div>
        </div>
        
        <div class="tiktok-detail-card">
          <div class="tiktok-detail-header">
            <div class="tiktok-detail-icon"><i class="fas fa-wallet"></i></div>
            <div class="tiktok-detail-label">Общий бюджет</div>
          </div>
          <div class="tiktok-detail-value">${getTotalFromStringArray(allBudgets)}</div>
          <div class="tiktok-detail-subtitle">выделенных средств</div>
        </div>
      `;
    }
    
    function generateEnhancedBuyerMetrics(metrics) {
      return `
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Активных дней</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">дней с активностью</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Дней в норме</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">соответствует CPL</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Превышений</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">дней превышения</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Конверсия</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">средний CR</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Видео</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">уникальных</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Лендинги</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">посадочных страниц</div>
        </div>
      `;
    }
    
    function generateEnhancedGroupMetrics(metrics) {
      return `
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Активных дней</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">дней с активностью</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Дней в норме</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">соответствует CPL</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Превышений</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">дней превышения</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Конверсия</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">CR группы</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Видео</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">креативов</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">Лендинги</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">страниц</div>
        </div>
      `;
    }
    
    function displaySegmentTable(tableId, data) {
      console.log(`📋 Отображаем таблицу ${tableId} с данными:`, data);
      
      const table = document.getElementById(tableId);
      if (!table) {
        console.error(`Таблица с ID ${tableId} не найдена`);
        return;
      }
      
      const rows = [
        'Дата',
        'Рейтинг',
        'CPL (день)',
        'Лиды (день)',
        'Расход (день)',
        'Конверт в день',
        'Max CPL (ROI +20%)',
        'CPL с учётом сбросов',
        'Частота (Frequency)',
        'CTR (целевая страница)',
        'CPM',
        'Клики (переход)',
        'CPC (целевая страница)',
        'Среднее время воспроизведения видео',
        'Название рекламы',
        'URL-адрес веб-сайта',
        'Бюджет группы объявлений'
      ];
      
      let html = '<thead><tr><th style="min-width: 220px;">Показатель</th>';
      data.dates.forEach(date => {
        html += `<th style="min-width: 140px;">${date}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      rows.forEach((rowName, index) => {
        html += `<tr><td class="metric-row">${rowName}</td>`;
        for (let i = 0; i < data.dates.length; i++) {
          let value = '';
          let className = '';
          let cellStyle = '';
          
          switch(index) {
            case 0: value = data.dates[i]; break;
            case 1: 
              value = data.ratings[i]; 
              className = value ? `rating-${value}` : '';
              break;
            case 2: value = formatNumberWithZero(data.cplDay[i]); break;
            case 3: value = data.leadsDay[i]; break;
            case 4: value = formatNumberWithZero(data.spendDay[i]); break;
            case 5: value = data.conversionDay ? data.conversionDay[i] : ''; break;
            case 6: value = formatNumber(data.maxCPL ? data.maxCPL[i] : ''); break;
            case 7:
              value = formatNumberWithZero(data.cplCumulative ? data.cplCumulative[i] : 0);
              if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                value += ' ' + data.cplCumulativeArrows[i];
              }
              if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                const color = data.cplCumulativeColors[i];
                if (color === 'green') {
                  cellStyle = 'background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;';
                } else if (color === 'red') {
                  cellStyle = 'background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;';
                } else if (color === 'gray') {
                  cellStyle = 'background-color: #f3f4f6 !important; color: #6b7280 !important;';
                }
              }
              break;
            case 8: value = data.freq ? data.freq[i] : ''; break;
            case 9: value = data.ctr ? data.ctr[i] : ''; break;
            case 10: value = data.cpm ? data.cpm[i] : ''; break;
            case 11: value = data.linkClicks ? data.linkClicks[i] : ''; break;
            case 12: value = data.cpc ? data.cpc[i] : ''; break;
            case 13: value = data.avgWatchTime ? data.avgWatchTime[i] : ''; break;
            case 14: value = data.videoName ? data.videoName[i] : ''; break;
            case 15: 
              // Обрабатываем URL-адреса - делаем их кликабельными
              const urlValue = data.siteUrl ? data.siteUrl[i] : '';
              value = makeUrlsClickable(urlValue);
              break;
            case 16: value = data.budget ? data.budget[i] : ''; break;
          }
          
          if (index === 15) {
            // Для URL-адресов вставляем HTML напрямую и добавляем класс url-cell
            html += `<td class="${className} url-cell" style="${cellStyle}">${value}</td>`;
          } else {
            html += `<td class="${className}" style="${cellStyle}">${escapeHtml(value)}</td>`;
          }
        }
        html += '</tr>';
      });
      
      html += '</tbody>';
      table.innerHTML = html;
    }
    
    function displaySegmentChart(chartId, article, segmentName, data) {
      const ctx = document.getElementById(chartId).getContext('2d');
      
      // Создаем градиенты для сегментов
      const gradientCPL = ctx.createLinearGradient(0, 0, 0, 400);
      gradientCPL.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
      gradientCPL.addColorStop(0.5, 'rgba(99, 102, 241, 0.15)');
      gradientCPL.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
      
      const gradientLeads = ctx.createLinearGradient(0, 0, 0, 400);
      gradientLeads.addColorStop(0, 'rgba(34, 197, 94, 0.25)');
      gradientLeads.addColorStop(1, 'rgba(34, 197, 94, 0.05)');
      
      const gradientSpend = ctx.createLinearGradient(0, 0, 0, 400);
      gradientSpend.addColorStop(0, 'rgba(251, 146, 60, 0.25)');
      gradientSpend.addColorStop(1, 'rgba(251, 146, 60, 0.05)');
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [
            {
              label: 'CPL за день',
              data: data.cplDay,
              borderColor: '#6366f1',
              backgroundColor: gradientCPL,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 8,
              pointBackgroundColor: '#6366f1',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              tension: 0,
              fill: true,
              order: 1
            },
            {
              label: 'Лиды за день',
              data: data.leadsDay,
              borderColor: '#22c55e',
              backgroundColor: gradientLeads,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#22c55e',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 2
            },
            {
              label: 'Расход за день',
              data: data.spendDay,
              borderColor: '#fb923c',
              backgroundColor: gradientSpend,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#fb923c',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 3
            },
            {
              label: 'Max CPL (норма)',
              data: data.maxCPL || [],
              borderColor: '#dc2626',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderDash: [10, 5],
              tension: 0,
              order: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            title: {
              display: true,
              text: `📊 ${article} - ${segmentName}`,
              font: {
                size: 20,
                weight: 'bold'
              },
              color: '#1e293b'
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.95)',
              titleColor: '#ffffff',
              bodyColor: '#e2e8f0',
              borderColor: '#475569',
              borderWidth: 1,
              cornerRadius: 12,
              callbacks: {
                title: function(context) {
                  return `📅 ${context[0].label}`;
                },
                label: function(context) {
                  const value = context.parsed.y;
                  const label = context.dataset.label;
                  
                  if (label.includes('CPL')) {
                    return `${label}: ${value.toFixed(2)}`;
                  } else if (label.includes('Расход')) {
                    return `${label}: ${value.toFixed(0)}`;
                  } else if (label.includes('Лиды')) {
                    return `${label}: ${value} шт`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(148, 163, 184, 0.15)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: '💰 CPL ($)',
                color: '#374151'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return ' + value.toFixed(1);
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: '📈 Лиды / Расход',
                color: '#374151'
              },
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          }
        }
      });
      
      currentCharts.push(chart);
    }
    
    function formatNumber(value) {
      if (value === 0 || value === '' || value === null || value === undefined) return '';
      const num = Number(value);
      if (isNaN(num)) return value;
      return num.toFixed(2).replace('.', ',');
    }
    
    // НОВАЯ ФУНКЦИЯ: для CPL показываем 0 вместо пустых значений
    function formatNumberWithZero(value) {
      if (value === null || value === undefined || value === '') return '0,00';
      const num = Number(value);
      if (isNaN(num)) return value;
      return num.toFixed(2).replace('.', ',');
    }
    
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
