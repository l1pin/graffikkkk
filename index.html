<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Analytics - TikTok Ads</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8fafc;
      color: #334155;
      min-height: 100vh;
      display: flex;
    }
    
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #1e293b;
      padding: 24px 0;
      box-shadow: 4px 0 12px rgba(0,0,0,0.15);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }
    
    .logo {
      padding: 0 24px 32px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 24px;
    }
    
    .logo h1 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo i {
      font-size: 28px;
    }
    
    .nav-menu {
      padding: 0 16px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .nav-item:hover,
    .nav-item.active {
      background: rgba(255,255,255,0.2);
      color: white;
      transform: translateX(4px);
    }
    
    .nav-item i {
      width: 20px;
      margin-right: 12px;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 24px 32px;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      background: white;
      border-radius: 12px;
      padding: 24px 32px;
      margin-bottom: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .header-subtitle {
      color: #64748b;
      font-size: 16px;
      margin-bottom: 24px;
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 20px;
      align-items: end;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .input-label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    
    .input-field {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #1e293b;
      box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
    }
    
    .period-inputs {
      display: flex;
      gap: 16px;
    }
    
    .btn-primary {
      background: #1e293b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.3);
      height: fit-content;
    }
    
    .btn-primary:hover {
      background: #334155;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 41, 59, 0.4);
    }
    
    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #1e293b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #64748b;
      font-size: 16px;
      font-weight: 500;
    }
    
    /* Error */
    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 20px 24px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 4px solid #dc2626;
      display: none;
      font-weight: 500;
      white-space: pre-line;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
    }
    
    .error-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .error-content {
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* Results */
    .results {
      display: none;
    }
    
    /* Status Banner */
    .status-banner {
      background: #1e293b;
      color: white;
      padding: 20px 32px;
      margin-bottom: 32px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(30, 41, 59, 0.3);
      display: none;
    }
    
    .status-banner.show {
      display: block;
    }
    
    .status-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .status-main {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .status-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .status-info h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
      font-weight: 700;
    }
    
    .status-info p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }
    
    .article-name {
      font-size: 20px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 8px;
    }
    
    /* Metrics */
    .metrics-section {
      margin-bottom: 32px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .section-title i {
      color: #475569;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .metrics-grid.single-row {
      grid-template-columns: repeat(6, 1fr);
    }
    
    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .metric-card.tooltip-container {
      position: relative;
    }
    
    .metric-card.tooltip-container::before {
      content: "ℹ️";
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 16px;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }
    
    .metric-card.tooltip-container:hover::before {
      opacity: 1;
    }
    
    .metric-card.tooltip-container:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.15);
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .metric-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-icon {
      width: 40px;
      height: 40px;
      background: #f1f5f9;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      font-size: 18px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .metric-subtitle {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 500;
    }

    .metric-additional {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #e2e8f0;
    }

    /* Efficiency Zones Styling - УЛУЧШЕННАЯ ВЕРСИЯ */
    .efficiency-zones {
      min-height: 240px;
    }
    
    .current-zone-display {
      margin-top: 8px;
      text-align: center;
    }
    
    .zone-percentage {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 20px;
      border: 2px solid;
      margin-bottom: 12px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    /* Цвета теперь читаются ДИНАМИЧЕСКИ из Google Sheets колонки AA */
    .zone-percentage {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 20px;
      border: 2px solid;
      margin-bottom: 12px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      /* Цвета задаются динамически через style="" в JavaScript */
    }
    
    .zones-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .zone-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      border-left: 3px solid;
      text-align: center;
    }
    
    .zone-red {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: #ef4444;
      color: #dc2626;
    }
    
    .zone-pink {
      background: rgba(236, 72, 153, 0.1);
      border-left-color: #ec4899;
      color: #be185d;
    }
    
    .zone-gold {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: #f59e0b;
      color: #d97706;
    }
    
    .zone-green {
      background: rgba(34, 197, 94, 0.1);
      border-left-color: #22c55e;
      color: #16a34a;
    }
    
    .zone-label {
      font-size: 11px;
      opacity: 0.8;
    }
    
    .zone-value {
      font-weight: 700;
      font-size: 13px;
    }
    
    /* Chart Section */
    .chart-section {
      background: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .chart-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chart-container {
      height: 500px;
      position: relative;
    }
    
    /* Table Section */
    .table-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
    }
    
    .data-table th {
      background: #f8fafc;
      color: #374151;
      font-weight: 600;
      padding: 16px 12px;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    .data-table th:first-child {
      position: sticky;
      left: 0;
      z-index: 11;
      background: #f8fafc;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      min-width: 220px;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
      max-width: 200px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    /* Специальные стили для ячеек с URL - УВЕЛИЧЕННЫЕ ДЛЯ ПОЛНЫХ АДРЕСОВ */
    .data-table td.url-cell {
      max-width: 400px;
      white-space: normal;
      line-height: 1.4;
      word-break: break-all;
    }
    
    .data-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 9;
      background: inherit;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      min-width: 220px;
    }
    
    .data-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .data-table tbody tr:hover {
      background: #f8fafc;
    }
    
    .data-table .metric-row {
      font-weight: 600;
      color: #374151;
      background: #fafafa !important;
    }
    
    /* Стили для кликабельных ссылок - ПОЛНЫЕ АДРЕСА */
    .clickable-url {
      color: #1a73e8;
      text-decoration: underline;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: inline-block;
      margin: 1px 0;
      background: rgba(26, 115, 232, 0.05);
      font-size: 12px;
      word-break: break-all;
      line-height: 1.3;
    }
    
    .clickable-url:hover {
      background: rgba(26, 115, 232, 0.1);
      color: #1557b0;
    }
    
    /* Rating Colors */
    .rating-A { 
      background: #dcfce7 !important; 
      color: #166534 !important;
      font-weight: 600;
    }
    .rating-B { 
      background: #fef3c7 !important; 
      color: #a16207 !important;
      font-weight: 600;
    }
    .rating-C { 
      background: #fed7aa !important; 
      color: #c2410c !important;
      font-weight: 600;
    }
    .rating-D { 
      background: #fecaca !important; 
      color: #dc2626 !important;
      font-weight: 600;
    }
    
    /* Group Sections */
    .group-section {
      margin-top: 48px;
      padding-top: 32px;
      border-top: 3px solid #e2e8f0;
    }
    
    .group-header {
      background: #1e293b;
      color: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(30, 41, 59, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .group-header:hover {
      background: #334155;
      box-shadow: 0 6px 24px rgba(30, 41, 59, 0.4);
    }
    
    .group-header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .group-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .group-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      font-weight: 500;
    }
    
    .group-toggle {
      background: none;
      border: none;
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .group-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .group-content {
      overflow: hidden;
      transition: max-height 0.5s ease, opacity 0.3s ease;
      max-height: 5000px;
      opacity: 1;
    }
    
    .group-content.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
    }

    /* Buyer Sections */
    .buyer-header {
      background: #059669;
      color: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(5, 150, 105, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .buyer-header:hover {
      background: #047857;
      box-shadow: 0 6px 24px rgba(5, 150, 105, 0.4);
    }

    /* Account Sections */
    .account-header {
      background: #7c3aed;
      color: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .account-header:hover {
      background: #6d28d9;
      box-shadow: 0 6px 24px rgba(124, 58, 237, 0.4);
    }
    
    /* Стили для всплывающих подсказок (Tooltips) */
    .tooltip-container {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    
    .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.95);
      color: white;
      padding: 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      line-height: 1.4;
      white-space: nowrap;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-line;
    }
    
    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -8px;
      border-width: 8px;
      border-style: solid;
      border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
    }
    
    .tooltip-container:hover .tooltip {
      visibility: visible;
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }
    
    .tooltip-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 8px;
      color: #60a5fa;
      border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      padding-bottom: 4px;
    }
    
    .tooltip-item {
      display: block;
      padding: 2px 0;
      color: #e2e8f0;
    }
    
    .tooltip-item:hover {
      color: #60a5fa;
    }
    
    /* Скролл для длинных списков */
    .tooltip::-webkit-scrollbar {
      width: 6px;
    }
    
    .tooltip::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    .tooltip::-webkit-scrollbar-thumb {
      background: rgba(96, 165, 250, 0.5);
      border-radius: 3px;
    }
    
    .tooltip::-webkit-scrollbar-thumb:hover {
      background: rgba(96, 165, 250, 0.7);
    }
    
    /* Адаптивное позиционирование tooltip для правого края */
    .tooltip-container:last-child .tooltip,
    .tooltip-container:nth-last-child(2) .tooltip {
      left: auto;
      right: 0;
      transform: translateX(0);
    }
    
    .tooltip-container:last-child:hover .tooltip,
    .tooltip-container:nth-last-child(2):hover .tooltip {
      transform: translateX(0) translateY(-8px);
    }
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
      
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .metrics-grid.single-row {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 20px;
      }
      
      .metric-card {
        padding: 20px;
      }
      
      .chart-section,
      .table-section {
        padding: 20px;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .metrics-grid.single-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .metrics-grid.single-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <h1><i class="fas fa-chart-line"></i> TikTok Ads</h1>
    </div>
    <nav class="nav-menu">
      <a href="#" class="nav-item active">
        <i class="fas fa-chart-bar"></i>
        Аналитика
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <h1>Аналитика по артикулам</h1>
      <div class="header-subtitle">Детальный анализ показателей эффективности рекламных кампаний TikTok Ads из базы данных</div>
      
      <div class="controls-grid">
        <div class="input-group">
          <label class="input-label">Артикул для анализа</label>
          <input type="text" id="articleInput" class="input-field" placeholder="Введите артикул..." />
        </div>
        
        <div class="period-inputs">
          <div class="input-group">
            <label class="input-label">Период с</label>
            <input type="date" id="periodStart" class="input-field">
          </div>
          <div class="input-group">
            <label class="input-label">по</label>
            <input type="date" id="periodEnd" class="input-field">
          </div>
        </div>
        
        <button id="buildChart" class="btn-primary" onclick="buildChart()">
          <i class="fas fa-chart-line"></i> Построить анализ
        </button>
      </div>
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">Обработка данных из базы данных...</div>
    </div>
    
    <!-- Error -->
    <div class="error" id="error">
      <div class="error-title">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Произошла ошибка</span>
      </div>
      <div class="error-content" id="errorContent"></div>
    </div>
    
    <!-- Results -->
    <div class="results" id="results">
      <!-- Status Banner -->
      <div class="status-banner" id="statusBanner"></div>
      
      <!-- General Metrics -->
      <div class="metrics-section">
        <h2 class="section-title">
          <i class="fas fa-chart-pie"></i>
          Ключевые показатели
        </h2>
        <div class="metrics-grid" id="generalMetrics"></div>
      </div>
      
      <!-- General Chart -->
      <div class="chart-section">
        <div class="chart-header">
          <div class="chart-title">📊 Динамика показателей</div>
          <div style="color: #64748b; font-size: 14px;">
            <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-right: 8px;"></span>
            Данные из базы данных
          </div>
        </div>
        <div class="chart-container">
          <canvas id="generalChart"></canvas>
        </div>
      </div>
      
      <!-- General Table -->
      <div class="table-section">
        <div class="chart-header">
          <div class="chart-title">Детальные данные</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="generalTable"></table>
        </div>
      </div>
      
      <!-- Groups -->
      <div id="groupsContainer"></div>
      
      <!-- Buyers -->
      <div id="buyersContainer"></div>
      
      <!-- Accounts -->
      <div id="accountsContainer"></div>
    </div>
  </div>

  <script>
    let currentCharts = [];
    
    // Функция для форматирования содержимого подсказок
    function formatTooltipContent(content, isUrls = false) {
      if (!content || content === 'Нет данных' || content.trim() === '') {
        return '<span class="tooltip-item" style="color: #94a3b8; font-style: italic;">Нет данных</span>';
      }
      
      // Разделяем по переносам строк и убираем пустые элементы
      const items = content.split('\n').filter(item => item.trim() !== '');
      
      if (items.length === 0) {
        return '<span class="tooltip-item" style="color: #94a3b8; font-style: italic;">Нет данных</span>';
      }
      
      // Убираем дубликаты и сортируем
      const uniqueItems = [...new Set(items)].sort();
      
      return uniqueItems.map((item, index) => {
        const trimmedItem = item.trim();
        
        if (isUrls && (trimmedItem.startsWith('http://') || trimmedItem.startsWith('https://'))) {
          // Для URL делаем кликабельными
          return `<a href="${trimmedItem}" target="_blank" class="tooltip-item" style="color: #60a5fa; text-decoration: underline;">${trimmedItem}</a>`;
        }
        
        return `<span class="tooltip-item">${escapeHtml(trimmedItem)}</span>`;
      }).join('\n');
    }
    
    // Функция для создания кликабельных ссылок - ПОКАЗЫВАЕМ ПОЛНЫЕ АДРЕСА
    function makeUrlsClickable(text) {
      if (!text || text.trim() === '') return '';
      
      const urls = text.split('\n').filter(url => url.trim() !== '');
      return urls.map(url => {
        const cleanUrl = url.trim();
        if (cleanUrl.startsWith('http://') || cleanUrl.startsWith('https://')) {
          // Показываем ПОЛНЫЙ адрес, не сокращаем
          return `<a href="${cleanUrl}" target="_blank" class="clickable-url" title="${cleanUrl}">${cleanUrl}</a>`;
        }
        return cleanUrl;
      }).join('<br>');
    }
    
    // Функция для сворачивания/разворачивания групп
    function toggleGroup(groupId) {
      const content = document.getElementById(groupId + '_content');
      const toggle = event.currentTarget.querySelector('.group-toggle i');
      
      if (content.classList.contains('collapsed')) {
        // Разворачиваем
        content.classList.remove('collapsed');
        toggle.classList.remove('fa-chevron-right');
        toggle.classList.add('fa-chevron-down');
        toggle.parentElement.classList.remove('collapsed');
      } else {
        // Сворачиваем
        content.classList.add('collapsed');
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-right');
        toggle.parentElement.classList.add('collapsed');
      }
    }
    
    // Делаем функцию глобально доступной
    window.toggleGroup = toggleGroup;
    
    function buildChart() {
      const article = document.getElementById('articleInput').value.trim();
      const periodStart = document.getElementById('periodStart').value;
      const periodEnd = document.getElementById('periodEnd').value;
      
      if (!article) {
        showError('📝 Введите артикул\n\nПожалуйста, укажите артикул для анализа в поле ввода.');
        return;
      }
      
      showLoading(true);
      hideError();
      hideResults();
      
      // Уничтожаем существующие графики
      currentCharts.forEach(chart => {
        try {
          chart.destroy();
        } catch(e) {
          console.log('Ошибка при уничтожении графика:', e);
        }
      });
      currentCharts = [];
      
      // Вызываем Google Apps Script функцию
      try {
        console.log('🚀 Запуск анализа для артикула:', article);
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .buildChartForArticle(article, periodStart, periodEnd);
      } catch (e) {
        console.error('❌ Ошибка при вызове Google Apps Script:', e);
        handleError('🔌 Google Apps Script недоступен!\n\nПроверьте подключение к интернету и обновите страницу.');
      }
    }
    
    function handleSuccess(data) {
      console.log('✅ Получены данные от Google Apps Script:', data);
      showLoading(false);
      displayResults(data);
    }
    
    function handleError(error) {
      console.error('❌ Ошибка Google Apps Script:', error);
      showLoading(false);
      showError(error.toString());
    }
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('buildChart').disabled = show;
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('error');
      const errorContent = document.getElementById('errorContent');
      errorContent.textContent = message;
      errorDiv.style.display = 'block';
    }
    
    function hideError() {
      document.getElementById('error').style.display = 'none';
    }
    
    function hideResults() {
      document.getElementById('results').style.display = 'none';
      document.getElementById('statusBanner').classList.remove('show');
    }
    
    function showResults() {
      document.getElementById('results').style.display = 'block';
    }
    
    function displayResults(data) {
      console.log('📊 Отображаем результаты:', data);
      
      // Статус баннер
      displayStatusBanner(data.article, data.generalMetrics);
      
      // Общие метрики
      displayGeneralMetrics(data.generalMetrics);
      
      // Общий график
      displayGeneralChart(data.article, data.generalData);
      
      // Общая таблица
      displayGeneralTable(data.generalData);
      
      // Группы
      displayGroups(data.article, data.groupsData || {});
      
      // Байеры
      displayBuyers(data.article, data.buyersData || {});
      
      // Аккаунты
      displayAccounts(data.article, data.accountsData || {});
      
      showResults();
    }
    
    function displayStatusBanner(article, metrics) {
      const container = document.getElementById('statusBanner');
      container.innerHTML = `
        <div class="status-content">
          <div class="status-main">
            <div class="status-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="status-info">
              <h3>Статус артикула</h3>
              <p>${escapeHtml(metrics.status || 'Активный')}</p>
            </div>
          </div>
          <div class="article-name">${escapeHtml(article)}</div>
        </div>
      `;
      container.classList.add('show');
    }
    
    function displayGeneralMetrics(metrics) {
      const container = document.getElementById('generalMetrics');
      
      // Получаем динамические цвета из Google Sheets или дефолтные
      let zoneValue, zoneBackground, zoneFontColor;
      
      if (typeof metrics.efficiencyZone === 'object' && metrics.efficiencyZone !== null) {
        zoneValue = metrics.efficiencyZone.value || '--,--%';
        zoneBackground = metrics.efficiencyZone.backgroundColor || '#f3f3f3';
        zoneFontColor = metrics.efficiencyZone.fontColor || '#666666';
      } else {
        zoneValue = metrics.efficiencyZone || '--,--%';
        zoneBackground = '#f3f3f3';
        zoneFontColor = '#666666';
      }
      
      console.log('Zone styling - Value:', zoneValue, 'Background:', zoneBackground, 'Font:', zoneFontColor);
      
      container.innerHTML = `
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Активных дней</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">дней с активностью</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Дней в норме</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">≤ ${metrics.displayMaxCPL} CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Дней ниже допустимой</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">≤ ${metrics.displayCPL_ROI_minus5} CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Конверсия</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">средний CR</div>
        </div>

        <div class="metric-card efficiency-zones">
          <div class="metric-header">
            <div class="metric-label">Зоны эффективности</div>
            <div class="metric-icon"><i class="fas fa-bullseye"></i></div>
          </div>
          <div class="current-zone-display">
            <div class="zone-percentage" style="background-color: ${zoneBackground} !important; color: ${zoneFontColor} !important; border-color: ${zoneFontColor};">${zoneValue}</div>
            <div class="metric-subtitle">текущая зона</div>
          </div>
          <div class="zones-grid">
            <div class="zone-item zone-red">
              <span class="zone-label">Красная:</span>
              <span class="zone-value">${metrics.zoneAB || '-'}</span>
            </div>
            <div class="zone-item zone-pink">
              <span class="zone-label">Розовая:</span>
              <span class="zone-value">${metrics.zoneAC || '-'}</span>
            </div>
            <div class="zone-item zone-gold">
              <span class="zone-label">Золотая:</span>
              <span class="zone-value">${metrics.zoneAD || '-'}</span>
            </div>
            <div class="zone-item zone-green">
              <span class="zone-label">Зеленая:</span>
              <span class="zone-value">${metrics.zoneAE || '-'}</span>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Остаток</div>
            <div class="metric-icon"><i class="fas fa-boxes"></i></div>
          </div>
          <div class="metric-value">${escapeHtml(metrics.stock || 'Не указано')}</div>
          <div class="metric-subtitle">на складе</div>
          <div class="metric-additional">На сколько дней: ${escapeHtml(metrics.stockDays || 'Не указано')}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Сезонность</div>
            <div class="metric-icon"><i class="fas fa-calendar-alt"></i></div>
          </div>
          <div class="metric-value" style="font-size: 18px;">${escapeHtml(metrics.season || 'Неизвестно')}</div>
          <div class="metric-subtitle">периоды активности</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Категория</div>
            <div class="metric-icon"><i class="fas fa-tags"></i></div>
          </div>
          <div class="metric-value" style="font-size: 18px;">${escapeHtml(metrics.category || 'Не указана')}</div>
          <div class="metric-subtitle">товарная группа</div>
        </div>
        
        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Всего групп</div>
            <div class="metric-icon"><i class="fas fa-layer-group"></i></div>
          </div>
          <div class="metric-value">${metrics.totalGroups}</div>
          <div class="metric-subtitle">активных групп</div>
          <div class="tooltip">
            <div class="tooltip-title">📁 Группы объявлений:</div>
            ${formatTooltipContent(metrics.groupNames || 'Нет данных')}
          </div>
        </div>

        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Байеров</div>
            <div class="metric-icon"><i class="fas fa-user-tie"></i></div>
          </div>
          <div class="metric-value">${metrics.totalBuyers}</div>
          <div class="metric-subtitle">медиабайеров</div>
          <div class="tooltip">
            <div class="tooltip-title">👤 Медиабайеры:</div>
            ${formatTooltipContent(metrics.buyerNames || 'Нет данных')}
          </div>
        </div>

        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Аккаунтов</div>
            <div class="metric-icon"><i class="fas fa-users"></i></div>
          </div>
          <div class="metric-value">${metrics.totalAccounts}</div>
          <div class="metric-subtitle">рекламных аккаунтов</div>
          <div class="tooltip">
            <div class="tooltip-title">🔑 Рекламные аккаунты:</div>
            ${formatTooltipContent(metrics.accountNames || 'Нет данных')}
          </div>
        </div>
        
        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Уникальных видео</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">креативов</div>
          <div class="tooltip">
            <div class="tooltip-title">🎬 Видео креативы:</div>
            ${formatTooltipContent(metrics.videoNames || 'Нет данных')}
          </div>
        </div>
        
        <div class="metric-card tooltip-container">
          <div class="metric-header">
            <div class="metric-label">Лендингов</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">посадочных страниц</div>
          <div class="tooltip">
            <div class="tooltip-title">🌐 Посадочные страницы:</div>
            ${formatTooltipContent(metrics.siteUrls || 'Нет данных', true)}
          </div>
        </div>
      `;
    }
    
    function displayGeneralChart(article, data) {
      const ctx = document.getElementById('generalChart').getContext('2d');
      
      // Создаем градиенты
      const gradientCPL = ctx.createLinearGradient(0, 0, 0, 400);
      gradientCPL.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
      gradientCPL.addColorStop(0.5, 'rgba(99, 102, 241, 0.15)');
      gradientCPL.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
      
      const gradientLeads = ctx.createLinearGradient(0, 0, 0, 400);
      gradientLeads.addColorStop(0, 'rgba(34, 197, 94, 0.25)');
      gradientLeads.addColorStop(1, 'rgba(34, 197, 94, 0.05)');
      
      const gradientSpend = ctx.createLinearGradient(0, 0, 0, 400);
      gradientSpend.addColorStop(0, 'rgba(251, 146, 60, 0.25)');
      gradientSpend.addColorStop(1, 'rgba(251, 146, 60, 0.05)');
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [
            {
              label: 'CPL за день',
              data: data.cplDay,
              borderColor: '#6366f1',
              backgroundColor: gradientCPL,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 8,
              pointBackgroundColor: '#6366f1',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              tension: 0,
              fill: true,
              order: 1
            },
            {
              label: 'Лиды за день',
              data: data.leadsDay,
              borderColor: '#22c55e',
              backgroundColor: gradientLeads,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#22c55e',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 2
            },
            {
              label: 'Расход за день',
              data: data.spendDay,
              borderColor: '#fb923c',
              backgroundColor: gradientSpend,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#fb923c',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 3
            },
            {
              label: 'Max CPL (норма)',
              data: data.maxCPL,
              borderColor: '#ef4444',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderDash: [10, 5],
              tension: 0,
              order: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            title: {
              display: true,
              text: `📊 Динамика показателей - ${article}`,
              font: {
                size: 22,
                weight: 'bold'
              },
              color: '#1e293b'
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.95)',
              titleColor: '#ffffff',
              bodyColor: '#e2e8f0',
              borderColor: '#475569',
              borderWidth: 1,
              cornerRadius: 12
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(148, 163, 184, 0.15)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: '💰 CPL ($)',
                color: '#374151'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return '$' + value.toFixed(1);
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: '📈 Лиды / Расход',
                color: '#374151'
              },
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          }
        }
      });
      
      currentCharts.push(chart);
    }
    
    function displayGeneralTable(data) {
      console.log('📋 Отображаем общую таблицу с данными:', data);
      
      const table = document.getElementById('generalTable');
      const rows = [
        'Дата',
        'Рейтинг',
        'CPL (день)',
        'Лиды (день)',
        'Расход (день)',
        'Конверт в день',
        'Max CPL (ROI +20%)',
        'CPL с учётом сбросов',
        'Группы',
        'Байеры',
        'Аккаунты',
        'Частота (Frequency)',
        'CTR (целевая страница)',
        'CPM',
        'Клики (переход)',
        'CPC (целевая страница)',
        'Среднее время воспроизведения видео',
        'Название рекламы',
        'URL-адрес веб-сайта',
        'Бюджет группы объявлений'
      ];
      
      let html = '<thead><tr><th style="min-width: 220px;">Показатель</th>';
      data.dates.forEach(date => {
        html += `<th style="min-width: 140px;">${date}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      rows.forEach((rowName, index) => {
        html += `<tr><td class="metric-row">${rowName}</td>`;
        for (let i = 0; i < data.dates.length; i++) {
          let value = '';
          let className = '';
          let cellStyle = '';
          
          switch(index) {
            case 0: value = data.dates[i]; break;
            case 1: 
              value = data.ratings[i]; 
              className = value ? `rating-${value}` : '';
              break;
            case 2: value = formatNumberWithZero(data.cplDay[i]); break;
            case 3: value = data.leadsDay[i]; break;
            case 4: value = formatNumberWithZero(data.spendDay[i]); break;
            case 5: value = data.conversionDay ? data.conversionDay[i] : ''; break;
            case 6: value = formatNumber(data.maxCPL[i]); break;
            case 7:
              value = formatNumberWithZero(data.cplCumulative[i]);
              if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                value += ' ' + data.cplCumulativeArrows[i];
              }
              if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                const color = data.cplCumulativeColors[i];
                if (color === 'green') {
                  cellStyle = 'background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;';
                } else if (color === 'red') {
                  cellStyle = 'background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;';
                } else if (color === 'gray') {
                  cellStyle = 'background-color: #f3f4f6 !important; color: #6b7280 !important;';
                }
              }
              break;
            case 8: value = data.groups ? data.groups[i] : ''; break;
            case 9: value = data.buyers ? data.buyers[i] : ''; break;
            case 10: value = data.accounts ? data.accounts[i] : ''; break;
            case 11: value = data.freq ? data.freq[i] : ''; break;
            case 12: value = data.ctr ? data.ctr[i] : ''; break;
            case 13: value = data.cpm ? data.cpm[i] : ''; break;
            case 14: value = data.linkClicks ? data.linkClicks[i] : ''; break;
            case 15: value = data.cpc ? data.cpc[i] : ''; break;
            case 16: value = data.avgWatchTime ? data.avgWatchTime[i] : ''; break;
            case 17: value = data.videoName ? data.videoName[i] : ''; break;
            case 18: 
              // Обрабатываем URL-адреса - делаем их кликабельными
              const urlValue = data.siteUrl ? data.siteUrl[i] : '';
              value = makeUrlsClickable(urlValue);
              break;
            case 19: value = data.budget ? data.budget[i] : ''; break;
          }
          
          if (index === 18) {
            // Для URL-адресов вставляем HTML напрямую и добавляем класс url-cell
            html += `<td class="${className} url-cell" style="${cellStyle}">${value}</td>`;
          } else {
            html += `<td class="${className}" style="${cellStyle}">${escapeHtml(value)}</td>`;
          }
        }
        html += '</tr>';
      });
      
      html += '</tbody>';
      table.innerHTML = html;
    }
    
    function displayGroups(article, groupsData) {
      console.log('👥 Отображаем группы:', groupsData);
      
      const container = document.getElementById('groupsContainer');
      let html = '';
      
      if (Object.keys(groupsData).length > 0) {
        html += `
          <div class="group-section">
            <h2 class="section-title">
              <i class="fas fa-layer-group"></i>
              Аналитика по группам объявлений
            </h2>
          </div>
        `;
        
        Object.keys(groupsData).forEach(groupName => {
          const groupData = groupsData[groupName];
          const chartId = `chart_group_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const tableId = `table_group_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          html += `
            <div class="group-section">
              <div class="group-header" onclick="toggleGroup('group_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}')">
                <div class="group-header-content">
                  <div>
                    <div class="group-title">
                      <i class="fas fa-folder"></i>
                      ${escapeHtml(groupName)}
                    </div>
                    <div class="group-subtitle">Детальная аналитика по группе объявлений</div>
                  </div>
                  <button class="group-toggle collapsed" type="button">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
              
              <div class="group-content collapsed" id="group_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}_content">
                <div class="metrics-grid single-row">
                  ${generateSegmentMetrics(groupData.metrics)}
                </div>
                
                <div class="chart-section">
                  <div class="chart-header">
                    <div class="chart-title">📈 Динамика группы: ${escapeHtml(groupName)}</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="${chartId}"></canvas>
                  </div>
                </div>
                
                <div class="table-section">
                  <div class="chart-header">
                    <div class="chart-title">Детальные данные группы</div>
                  </div>
                  <div class="table-container">
                    <table class="data-table" id="${tableId}"></table>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // Создаем таблицы и графики для групп
        Object.keys(groupsData).forEach(groupName => {
          const groupData = groupsData[groupName];
          const chartId = `chart_group_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const tableId = `table_group_${groupName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          displaySegmentTable(tableId, groupData.data);
          displaySegmentChart(chartId, article, groupName, groupData.data);
        });
      } else {
        container.innerHTML = '';
      }
    }

    function displayBuyers(article, buyersData) {
      console.log('👤 Отображаем байеров:', buyersData);
      
      const container = document.getElementById('buyersContainer');
      let html = '';
      
      if (Object.keys(buyersData).length > 0) {
        html += `
          <div class="group-section" style="border-top-color: #059669;">
            <h2 class="section-title">
              <i class="fas fa-user-tie"></i>
              Аналитика по медиабайерам
            </h2>
          </div>
        `;
        
        Object.keys(buyersData).forEach(buyerName => {
          const buyerData = buyersData[buyerName];
          const chartId = `chart_buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const tableId = `table_buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          html += `
            <div class="group-section">
              <div class="buyer-header" onclick="toggleGroup('buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}')">
                <div class="group-header-content">
                  <div>
                    <div class="group-title">
                      <i class="fas fa-user-tie"></i>
                      ${escapeHtml(buyerName)}
                    </div>
                    <div class="group-subtitle">Детальная аналитика по медиабайеру</div>
                  </div>
                  <button class="group-toggle collapsed" type="button">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
              
              <div class="group-content collapsed" id="buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}_content">
                <div class="metrics-grid single-row">
                  ${generateSegmentMetrics(buyerData.metrics)}
                </div>
                
                <div class="chart-section">
                  <div class="chart-header">
                    <div class="chart-title">👤 Динамика байера: ${escapeHtml(buyerName)}</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="${chartId}"></canvas>
                  </div>
                </div>
                
                <div class="table-section">
                  <div class="chart-header">
                    <div class="chart-title">Детальные данные байера</div>
                  </div>
                  <div class="table-container">
                    <table class="data-table" id="${tableId}"></table>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // Создаем таблицы и графики для байеров
        Object.keys(buyersData).forEach(buyerName => {
          const buyerData = buyersData[buyerName];
          const chartId = `chart_buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const tableId = `table_buyer_${buyerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          displaySegmentTable(tableId, buyerData.data);
          displaySegmentChart(chartId, article, buyerName, buyerData.data);
        });
      } else {
        container.innerHTML = '';
      }
    }

    function displayAccounts(article, accountsData) {
      console.log('🔑 Отображаем аккаунты:', accountsData);
      
      const container = document.getElementById('accountsContainer');
      let html = '';
      
      if (Object.keys(accountsData).length > 0) {
        html += `
          <div class="group-section" style="border-top-color: #7c3aed;">
            <h2 class="section-title">
              <i class="fas fa-users"></i>
              Аналитика по рекламным аккаунтам
            </h2>
          </div>
        `;
        
        Object.keys(accountsData).forEach(accountName => {
          const accountData = accountsData[accountName];
          const chartId = `chart_account_${accountName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const tableId = `table_account_${accountName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          html += `
            <div class="group-section">
              <div class="account-header" onclick="toggleGroup('account_${accountName.replace(/[^a-zA-Z0-9]/g, '_')}')">
                <div class="group-header-content">
                  <div>
                    <div class="group-title">
                      <i class="fas fa-users"></i>
                      ${escapeHtml(accountName)}
                    </div>
                    <div class="group-subtitle">Детальная аналитика по рекламному аккаунту</div>
                  </div>
                  <button class="group-toggle collapsed" type="button">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
              
              <div class="group-content collapsed" id="account_${accountName.replace(/[^a-zA-Z0-9]/g, '_')}_content">
                <div class="metrics-grid single-row">
                  ${generateSegmentMetrics(accountData.metrics)}
                </div>
                
                <div class="chart-section">
                  <div class="chart-header">
                    <div class="chart-title">🔑 Динамика аккаунта: ${escapeHtml(accountName)}</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="${chartId}"></canvas>
                  </div>
                </div>
                
                <div class="table-section">
                  <div class="chart-header">
                    <div class="chart-title">Детальные данные аккаунта</div>
                  </div>
                  <div class="table-container">
                    <table class="data-table" id="${tableId}"></table>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // Создаем таблицы и графики для аккаунтов
        Object.keys(accountsData).forEach(accountName => {
          const accountData = accountsData[accountName];
          const chartId = `chart_account_${accountName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const tableId = `table_account_${accountName.replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          displaySegmentTable(tableId, accountData.data);
          displaySegmentChart(chartId, article, accountName, accountData.data);
        });
      } else {
        container.innerHTML = '';
      }
    }
    
    function generateSegmentMetrics(metrics) {
      return `
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Активных дней</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">дней с активностью</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Дней в норме</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">соответствует CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Дней ниже допустимой</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">превышение CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Конверсия</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">CR сегмента</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Видео</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">уникальных</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Лендинги</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">посадочных страниц</div>
        </div>
      `;
    }
    
    function displaySegmentTable(tableId, data) {
      console.log(`📋 Отображаем таблицу ${tableId} с данными:`, data);
      
      const table = document.getElementById(tableId);
      if (!table) {
        console.error(`Таблица с ID ${tableId} не найдена`);
        return;
      }
      
      const rows = [
        'Дата',
        'Рейтинг',
        'CPL (день)',
        'Лиды (день)',
        'Расход (день)',
        'Конверт в день',
        'Max CPL (ROI +20%)',
        'CPL с учётом сбросов',
        'Частота (Frequency)',
        'CTR (целевая страница)',
        'CPM',
        'Клики (переход)',
        'CPC (целевая страница)',
        'Среднее время воспроизведения видео',
        'Название рекламы',
        'URL-адрес веб-сайта',
        'Бюджет группы объявлений'
      ];
      
      let html = '<thead><tr><th style="min-width: 220px;">Показатель</th>';
      data.dates.forEach(date => {
        html += `<th style="min-width: 140px;">${date}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      rows.forEach((rowName, index) => {
        html += `<tr><td class="metric-row">${rowName}</td>`;
        for (let i = 0; i < data.dates.length; i++) {
          let value = '';
          let className = '';
          let cellStyle = '';
          
          switch(index) {
            case 0: value = data.dates[i]; break;
            case 1: 
              value = data.ratings[i]; 
              className = value ? `rating-${value}` : '';
              break;
            case 2: value = formatNumberWithZero(data.cplDay[i]); break;
            case 3: value = data.leadsDay[i]; break;
            case 4: value = formatNumberWithZero(data.spendDay[i]); break;
            case 5: value = data.conversionDay ? data.conversionDay[i] : ''; break;
            case 6: value = formatNumber(data.maxCPL ? data.maxCPL[i] : ''); break;
            case 7:
              value = formatNumberWithZero(data.cplCumulative ? data.cplCumulative[i] : 0);
              if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                value += ' ' + data.cplCumulativeArrows[i];
              }
              if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                const color = data.cplCumulativeColors[i];
                if (color === 'green') {
                  cellStyle = 'background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;';
                } else if (color === 'red') {
                  cellStyle = 'background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;';
                } else if (color === 'gray') {
                  cellStyle = 'background-color: #f3f4f6 !important; color: #6b7280 !important;';
                }
              }
              break;
            case 8: value = data.freq ? data.freq[i] : ''; break;
            case 9: value = data.ctr ? data.ctr[i] : ''; break;
            case 10: value = data.cpm ? data.cpm[i] : ''; break;
            case 11: value = data.linkClicks ? data.linkClicks[i] : ''; break;
            case 12: value = data.cpc ? data.cpc[i] : ''; break;
            case 13: value = data.avgWatchTime ? data.avgWatchTime[i] : ''; break;
            case 14: value = data.videoName ? data.videoName[i] : ''; break;
            case 15: 
              // Обрабатываем URL-адреса - делаем их кликабельными
              const urlValue = data.siteUrl ? data.siteUrl[i] : '';
              value = makeUrlsClickable(urlValue);
              break;
            case 16: value = data.budget ? data.budget[i] : ''; break;
          }
          
          if (index === 15) {
            // Для URL-адресов вставляем HTML напрямую и добавляем класс url-cell
            html += `<td class="${className} url-cell" style="${cellStyle}">${value}</td>`;
          } else {
            html += `<td class="${className}" style="${cellStyle}">${escapeHtml(value)}</td>`;
          }
        }
        html += '</tr>';
      });
      
      html += '</tbody>';
      table.innerHTML = html;
    }
    
    function displaySegmentChart(chartId, article, segmentName, data) {
      const ctx = document.getElementById(chartId).getContext('2d');
      
      // Создаем градиенты для сегментов
      const gradientCPL = ctx.createLinearGradient(0, 0, 0, 400);
      gradientCPL.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
      gradientCPL.addColorStop(0.5, 'rgba(99, 102, 241, 0.15)');
      gradientCPL.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
      
      const gradientLeads = ctx.createLinearGradient(0, 0, 0, 400);
      gradientLeads.addColorStop(0, 'rgba(34, 197, 94, 0.25)');
      gradientLeads.addColorStop(1, 'rgba(34, 197, 94, 0.05)');
      
      const gradientSpend = ctx.createLinearGradient(0, 0, 0, 400);
      gradientSpend.addColorStop(0, 'rgba(251, 146, 60, 0.25)');
      gradientSpend.addColorStop(1, 'rgba(251, 146, 60, 0.05)');
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [
            {
              label: 'CPL за день',
              data: data.cplDay,
              borderColor: '#6366f1',
              backgroundColor: gradientCPL,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 8,
              pointBackgroundColor: '#6366f1',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              tension: 0,
              fill: true,
              order: 1
            },
            {
              label: 'Лиды за день',
              data: data.leadsDay,
              borderColor: '#22c55e',
              backgroundColor: gradientLeads,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#22c55e',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 2
            },
            {
              label: 'Расход за день',
              data: data.spendDay,
              borderColor: '#fb923c',
              backgroundColor: gradientSpend,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: '#fb923c',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: 'y1',
              order: 3
            },
            {
              label: 'Max CPL (норма)',
              data: data.maxCPL || [],
              borderColor: '#dc2626',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderDash: [10, 5],
              tension: 0,
              order: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            title: {
              display: true,
              text: `📊 ${article} - ${segmentName}`,
              font: {
                size: 20,
                weight: 'bold'
              },
              color: '#1e293b'
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.95)',
              titleColor: '#ffffff',
              bodyColor: '#e2e8f0',
              borderColor: '#475569',
              borderWidth: 1,
              cornerRadius: 12,
              callbacks: {
                title: function(context) {
                  return `📅 ${context[0].label}`;
                },
                label: function(context) {
                  const value = context.parsed.y;
                  const label = context.dataset.label;
                  
                  if (label.includes('CPL')) {
                    return `${label}: $${value.toFixed(2)}`;
                  } else if (label.includes('Расход')) {
                    return `${label}: $${value.toFixed(0)}`;
                  } else if (label.includes('Лиды')) {
                    return `${label}: ${value} шт`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(148, 163, 184, 0.15)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: '💰 CPL ($)',
                color: '#374151'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return '$' + value.toFixed(1);
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: '📈 Лиды / Расход',
                color: '#374151'
              },
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                color: '#64748b',
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          }
        }
      });
      
      currentCharts.push(chart);
    }
    
    function formatNumber(value) {
      if (value === 0 || value === '' || value === null || value === undefined) return '';
      const num = Number(value);
      if (isNaN(num)) return value;
      return num.toFixed(2).replace('.', ',');
    }
    
    // НОВАЯ ФУНКЦИЯ: для CPL показываем 0 вместо пустых значений
    function formatNumberWithZero(value) {
      if (value === null || value === undefined || value === '') return '0,00';
      const num = Number(value);
      if (isNaN(num)) return value;
      return num.toFixed(2).replace('.', ',');
    }
    
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
